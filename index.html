<html>
    <head>
        <title>CraftOS-PC for VS Code</title>
        <meta charset="utf-8">
        <style>
            #textmode {
                font-family: 'Courier New', Courier, monospace;
            }
            .main-container {
                line-height: 12px;
                width: max-content;
                overflow: visible;
            }
            .main-container br {
                height: 0;
                padding: 0;
                margin: 0;
                line-height: 12px;
            }
            .border-left, .border-right, .border-top, .border-bottom, .border-top-right, .border-top-left, .border-bottom-left, .border-bottom-right {
                background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3wQCDTMCYoj9XgAAA2pJREFUeNrt3T1OAkEYgOFvDTeZyDHo4BiUegC4hq0GSo5gKVYbPQMGM9giHmItDIlaSNT1B+Z5Ogo3kzH7ZnaZXaqUUhNAkaqH1YUAQKGOTAGUq7PeLMwCWAEAAgAIACAAgAAAAgAclE5dL80CFKqyFRhcAgAlrgA8CwAF3wOwFRhcAgACAAgAIACAAAACABwaW4HBCgAokWcBAAAAAODAVSml5no+joiIj54MrOtlTCf3kXOuIiLavHm4Peb2uNfz8c6xRMSb8QCf1/ni3zXzq1Frg+gPzhonMvy+r+wDaFb5vNVBzK9G4etI2IMVQErpzefHp7tvD6Kul3FyehzTSYgA/PMVQKsnP7CnAQAEABAAQAAAAQD+v85PHfj9i0Z6va7ZhlICEPGyVTciYtfWXsAlAHBIK4DtQ0ZAYQHo9bqW/eASABAAQAAAAQAEACg6AH6aDP7Op78GzDlX/cFZM5vN4ub20gxCaSuAnHM1HA5bHYg3/MIerABeR6DNd/g5+WGPAuCkhUIvAQABAAQAEACgiAC48QdWAIAAAAIACAAgAIAAAAIACAAgAIAAAAIACAAgAIAAAAIACAAgAIAAAAIACAAgAIAAAAIACABQQAD8UAlYAQACAAgAIACAAAACAAgAIAAgAKYABAAQAEAAAAEABAAQAEAAAAEABAAQAEAAAAEABAAQAEAAAAEABAAQAEAAAAEABAAQAEAAAAEABAAQAEAAAAEABAAQAEAAAAEABAAQAEAAAAEAAQAEABAAQAAAAQAEABAAQAAAAQAEABAAQAAAAQAEABAAQAAAAQAEABAAQAAAAQAEABAAQAAAAQAEABAAQAAAAQAEABAAQAAAAQAEABAAQAAAAQABAAQAEABAAAABAAQAEABAAAABAAQAEABAAAABAAQAEABAAAABAAQAEABAAAABAAQAEABAAAABAAQAEABAAAABAAQAEABAAAABAAQAEABAAAABAAEABAAQAEAAAAEABAAQAEAAAAEABAAQAEAAAAEABAAQAEAAAAEABKA1jX8jWAEAAgAIACAAgAAAAgAIACAAIACAAAACAAgAIACAAAACAAgAIACAAAACAAgAIACAAAACAAgAIACAAAACAAgAIACAAAACAAgAIACAAAACALQVgNVDN9abhdmAwjwDx3yAV9Yqo3UAAAAASUVORK5CYII=");
                background-repeat: no-repeat;
                display: inline-block;
                line-height: 1;
                padding: 0;
                margin: 0;
            }
            .border-left {
                width: 12px;
                height: 234px;
                background-position: 0px -28px;
                transform: scaleY(calc(352 / 227)) translateY(-34px);
            }
            .border-right {
                width: 12px;
                height: 234px;
                background-position: -36px -28px;
                transform: scaleY(calc(352 / 227)) translateY(-34px) translateX(-1px);
            }
            .border-top {
                width: 256px;
                height: 12px;
                background-position: 0px 0px;
                transform: scaleX(calc(620 / 256)) translateX(75px);
            }
            .border-bottom {
                width: 256px;
                height: 12px;
                background-position: 0px -12px;
                transform: scaleX(calc(620 / 256)) translateX(75px);
            }
            .border-top-left {
                width: 12px;
                height: 12px;
                background-position: -12px -28px;
            }
            .border-top-right {
                width: 12px;
                height: 12px;
                background-position: -24px -28px;
                transform: translateX(363px);
            }
            .border-bottom-left {
                width: 12px;
                height: 12px;
                background-position: -12px -40px;
            }
            .border-bottom-right {
                width: 12px;
                height: 12px;
                background-position: -24px -40px;
                transform: translateX(363px);
            }
            #pastebox {
                position: absolute;
                top: 0;
                left: 0;
                width: calc(100vw - 8px);
                height: calc(100vh - 8px);
                opacity: 0;
                overflow: hidden;
                z-index: 500;
                cursor: default;
            }
        </style>
        <script>
            var keymap = {
                '1': 2, '!': 2,
                '2': 3, '@': 3,
                '3': 4, '#': 4,
                '4': 5, '$': 5,
                '5': 6, '%': 6,
                '6': 7, '^': 7,
                '7': 8, '&': 8,
                '8': 9, '*': 9,
                '9': 10, '(': 10,
                '0': 11, ')': 11,
                '-': 12, '_': 12,
                '=': 13, '+': 13,
                "Backspace": 14,
                'Tab': 15,
                'q': 16, 'Q': 16,
                'w': 17, 'W': 17,
                'e': 18, 'E': 18,
                'r': 19, 'R': 19,
                't': 20, 'T': 20,
                'y': 21, 'Y': 21,
                'u': 22, 'U': 22,
                'i': 23, 'I': 23,
                'o': 24, 'O': 24,
                'p': 25, 'P': 25,
                '[': 26, '{': 26,
                ']': 27, '}': 27,
                'Enter': 28,
                'a': 30, 'A': 30,
                's': 31, 'S': 31,
                'd': 32, 'D': 32,
                'f': 33, 'F': 33,
                'g': 34, 'G': 34,
                'h': 35, 'H': 35,
                'j': 36, 'J': 36,
                'k': 37, 'K': 37,
                'l': 38, 'L': 38,
                ';': 39, ':': 39,
                '\'': 40, '"': 40,
                '\\': 43, '|': 43,
                'z': 44, 'Z': 44,
                'x': 45, 'X': 45,
                'c': 46, 'C': 46,
                'v': 47, 'V': 47,
                'b': 48, 'B': 48,
                'n': 49, 'N': 49,
                'm': 50, 'M': 50,
                ',': 51, '<': 51,
                '.': 52, '>': 52,
                '/': 53, '?': 53,
                ' ': 57,
                "F1": 59,
                "F2": 60,
                "F3": 61,
                "F4": 62,
                "F5": 63,
                "F6": 64,
                "F7": 65,
                "F8": 66,
                "F9": 67,
                "F10": 68,
                "F11": 87,
                "F12": 88,
                "F13": 100,
                "F14": 101,
                "F15": 102,
                "ArrowUp": 200,
                "ArrowLeft": 203,
                "ArrowRight": 205,
                "ArrowDown": 208,
                "Home": 199,
                "End": 207,
                "Control": 29,
                "Alt": 56,
                "Shift": 42,
                "Delete": 211
            };
        </script>
        <script>
            const vscode = acquireVsCodeApi();
            var lastMode = 0;
            function abspos(x, y, width) {return (y * width + x) * 4;}
            function setpx(data, x, y, c) {
                data.data[abspos(x, y, data.width)] = c.r;
                data.data[abspos(x, y, data.width) + 1] = c.g;
                data.data[abspos(x, y, data.width) + 2] = c.b;
                data.data[abspos(x, y, data.width) + 3] = 255;
            }
            var font = null;
            function drawChar(data, c, x, y, fg, bg, transparent) {
                const srcrect = {
                    width: 12,
                    height: 18,
                    x: 16*(c & 0x0F)+2,
                    y: 22*(c >> 4)+2,
                };
                const destrect = {
                    x: x * 12, 
                    y: y * 18, 
                    width: 12, 
                    height: 18
                };
                for (let yy = 0; yy < 18; yy++) {
                    for (let xx = 0; xx < 12; xx++) {
                        let c = font.data[abspos(srcrect.x + xx, srcrect.y + yy, font.width) + 3] > 127 ? fg : bg;
                        if (transparent && c === bg) continue;
                        setpx(data, destrect.x + xx, destrect.y + yy, c);
                    }
                }
            }
            var ctx = null, ctxdata = null;
            function render(term) {
                if (typeof term !== "object") return;
                if (typeof term.fontPath === "string") {
                    document.getElementById("font_img").src = term.fontPath;
                    const ctx = document.getElementById("font").getContext("2d");
                    ctx.clearRect(0, 0, 256, 350);
                    //ctx.drawImage(document.getElementById("font_img"), 0, 0);
                    //font = ctx.getImageData(0, 0, 256, 350);
                    return;
                }
                if (term.palette === undefined || ctx == null || ctxdata == null || font == null) return;
                lastMode = term.mode;
                if (term.mode == 0) {
                    for (let y = 0; y < term.height; y++)
                        for (let x = 0; x < term.width; x++)
                            drawChar(ctxdata, term.screen[y][x], x, y, term.palette[term.colors[y][x] & 0x0f], term.palette[term.colors[y][x] >> 4]);
                    if (term.blink) drawChar(ctxdata, "_".charCodeAt(0), term.cursorX, term.cursorY, term.palette[term.colors[term.cursorY][term.cursorX] & 0x0f], term.palette[term.colors[term.cursorY][term.cursorX] >> 4], true);
                } else if (term.mode == 1 || term.mode == 2) {
                    for (let y = 0; y < term.height * 9; y++) {
                        for (let x = 0; x < term.width * 6; x++) {
                            setpx(ctxdata, x * 2, y * 2, term.palette[term.pixels[y][x]]);
                            setpx(ctxdata, x * 2 + 1, y * 2, term.palette[term.pixels[y][x]]);
                            setpx(ctxdata, x * 2, y * 2 + 1, term.palette[term.pixels[y][x]]);
                            setpx(ctxdata, x * 2 + 1, y * 2 + 1, term.palette[term.pixels[y][x]]);
                        }
                    }
                }
                ctx.fillStyle = "#" + ((term.palette[15].r << 16) | (term.palette[15].g << 8) | term.palette[15].b).toString(16);
                ctx.fillRect(0, 0, 620, 350);
                ctx.putImageData(ctxdata, 4, 4);
            }
            function sendPacket(type, extra) {
                vscode.postMessage({type: type, data: extra});
            }
            function pack8(n) {return ("0" + n.toString(16)).slice(-2);}
            function pack16(n) {return pack8(n & 0xFF) + pack8((n >> 8) & 0xFF);}
            function pack32(n) {return pack16(n & 0xFFFF) + pack16((n >> 16) & 0xFFFF);}
            function packstr(s) {
                let retval = "";
                for (let i = 0; i < s.length; i++) retval += pack8(s.charCodeAt(i));
                return retval + "00";
            }
            var lastMouse = {x: 0, y: 0};
            var events = {};
            events.key = e => {
                if (keymap[e.key] != null) {
                    if (!(e.key === 'v' && (e.ctrlKey || e.metaKey))) {
                        e.stopPropagation();
                        e.preventDefault();
                    }
                    const flags = (e.repeat ? 2 : 0) | (e.ctrlKey ? 4 : 0);
                    sendPacket(1, pack8(keymap[e.key]) + pack8(flags));
                    if (e.key.length == 1 && !e.ctrlKey && !e.altKey && !e.metaKey) sendPacket(1, pack8(e.key.charCodeAt(0)) + "09");
                    return e.key === 'v' && (e.ctrlKey || e.metaKey);
                } else return true;
            }
            events.key_up = e => {
                if (keymap[e.key] != null) {
                    e.stopPropagation();
                    e.preventDefault();
                    sendPacket(1, pack8(keymap[e.key]) + "01");
                    return false;
                } else return true;
            }
            events.mouse_click = e => {
                e.stopPropagation();
                e.preventDefault();
                lastMouse = {x: -1, y: -1};
                if (lastMode == 0) sendPacket(2, "00" + pack8(e.which) + pack32((e.offsetX - 4) / 12 + 1) + pack32((e.offsetY - 4) / 18 + 1));
                else if (lastMode == 1 || lastMode == 2) sendPacket(2, "00" + pack8(e.which) + pack32((e.offsetX - 4) / 2 + 1) + pack32((e.offsetY - 4) / 2 + 1));
            }
            events.mouse_up = e => {
                e.stopPropagation();
                e.preventDefault();
                if (lastMode == 0) sendPacket(2, "01" + pack8(e.which) + pack32((e.offsetX - 4) / 12 + 1) + pack32((e.offsetY - 4) / 18 + 1));
                else if (lastMode == 1 || lastMode == 2) sendPacket(2, "01" + pack8(e.which) + pack32((e.offsetX - 4) / 2 + 1) + pack32((e.offsetY - 4) / 2 + 1));
            }
            events.mouse_scroll = e => {
                e.stopPropagation();
                e.preventDefault();
                sendPacket(2, "02" + pack8(e.deltaY > 0 ? 1 : 0) + "0000000000000000");
            }
            events.mouse_drag = e => {
                if (e.buttons) {
                    e.stopPropagation();
                    e.preventDefault();
                    if (lastMode == 0 && (lastMouse.x !== Math.floor((e.offsetX - 4) / 12 + 1) || lastMouse.y !== Math.floor((e.offsetY - 4) / 18 + 1))) {
                        sendPacket(2, "03" + pack8(e.which) + pack32((e.offsetX - 4) / 12 + 1) + pack32((e.offsetY - 4) / 18 + 1));
                        lastMouse = {x: Math.floor((e.offsetX - 4) / 12 + 1), y: Math.floor((e.offsetY - 4) / 18 + 1)};
                    } else if ((lastMode == 1 || lastMode == 2) && (lastMouse.x !== Math.floor((e.offsetX - 4) / 2 + 1) || lastMouse.y !== Math.floor((e.offsetY - 4) / 2 + 1))) {
                        sendPacket(2, "03" + pack8(e.which) + pack32((e.offsetX - 4) / 2 + 1) + pack32((e.offsetY - 4) / 2 + 1));
                        lastMouse = {x: Math.floor((e.offsetX - 4) / 2 + 1), y: Math.floor((e.offsetY - 4) / 2 + 1)};
                    }
                }
            }
            events.paste = e => {
                const data = e.clipboardData.getData("text/plain");
                if (typeof data === "string") {
                    e.stopPropagation();
                    e.preventDefault();
                    sendPacket(3, "01" + packstr("paste") + "03" + packstr(data.replace(/\n.*$/, "")));
                }
                document.getElementById("pastebox").innerHTML = "";
            }
            window.addEventListener("message", (ev) => render(ev.data));
        </script>
    </head>
    <body>
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAFeAgMAAAAXmClyAAAADFBMVEWL+TQAYHMAAAD///+6/8vMAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAHdElNRQflBRITGCFov6XbAAAGO0lEQVR42u2cAWLbIAxFucG//y11AxYDEhKYzInkpOsgc7vazovBQv4IkZR+RslUNy5Q/836QLLnhQFwvHJOiai+OZNADAC5nFtB+dgoCECPA2iQrCH0+Ad1zQpAj9+UogCtCuN2XGY5Td6P523wPgDoDfnYtwIgqdtNSVXBDThepBpQNtuIBcC3t7QxggBiyphN2xhS7qYcDHhSps6EF3u6G7DLRwuak2idSPbh6q17FwD+edjLA1C6NqXZxEcQUu3yfkBu7rq49QaAdKT+Kce+VrNSVXG8foA6qTSicpzq0uU87mBSPT+gVkEAqBCuQm+sWgVwFaRx3QB2q2I8qL5resy1qnRHEwQwwqFVAaWB8qkByQedqhQXAKcO9cXu7ALs8hM88mHCTWhCbJaaWf/t3ocCirCi+n+RNLQwNooEUJN3fIA7EbUTCHcDUmpVYCcCdQ6q5OtOdahSFKAeqOKWHy5Pq0BhgNSrAH7ImltH9kGTdAOHAHQjsilndH2bz60XKQyQfM73w4Bd7opeQA+0skgaGYybUY/q5pkCANVs2+AzNYEhXg1q/9yx0O3eBWCxBHEcR5dGHxRbAMu+AgoBAF1MHw3XziqOhYf7WuoYJ0IRAHaWpAVnv2xMOk+R6gd7AepEufwJQOY2GpnrBtigC/UBmDFx7dKVKSMEsD3yLhJYbMKi/bbhQIiBjcbenLAT0JzY8NIeDGLCh+wBB3GpdzgnAET1kqlfXubxuAoN8H4OoSIUMDVQso01VqG8chggvwAYnV4IYNixAuA2AJvrZMrscJWTlSD+2Bd8gF12KYNNUk41G0MxL3a+yU6lBQCGrmE7TgtKEMmQuIox3hcCkE7SZc1SZCtAD9y6AYOzOq2CDodgGPffBiihAKhq6Aa8AUCzvD0AlNW+OwESkB8C0QY6SuEwgK8n5y8DdgmNKaezuFjuf/GP04HWbQCcjLPuAbQhfgmBFseKPuQ/HjIgVYXWsagPDyIA7fEicjNbaUdQAJKoh3oURQDkgaqSWjBLXR6ExwPOpK5WsdrRTg+eEEBqQx59+7TE7wDIg9VKXTfgmX7Scce3BJgHsMu3vfQi3NFMvGxUDeujAB0STLlP5LgA1Zm2tAmR9Au5PwenKQBAzZHSWu5LWJTGoCRSAEA7p1HuA3YSd6gCbAT/XQAPttT8lxbbPJErlz81ohvQw9MqIJ+tW5eQuTLl3ohBgMvO1Vg2BQCcvoO+DAgN7B4/c0slVH/nK39vwO8ATMH+rLMM7Z6xbMAdgF3+7+m2K90XF/zBBvy7gO0Tvw0Y3/DqtgG/A/DDohZqgRQPumRKLD+bHnADGEJ2cgqkH1109jiLAvDETEvYk5CoVInqkguo8DWIYgE8ZQiVwcohz8f7iNOwZeneDYDUUwpl8N0BNXze7zmAcAAE0AMNuTdi+YA+P4Bxxs4NkNunl5zwsN8sUXliSO8DzJQIfF0aO/3t35TqKt6q56RPk1tVqFDCYF6AxMP0mo/UUnC1t8+kIoAmByMI0HJ9+2XqjsOOBn3yHj2xwQkoMUYOiSpAcWdqGcaUTiEJwm4Au7ShCuV6ZZmi2ke5LRjPdprVDbC+BdZ9cdC6pNVk+Q2zIsQFmIOw1AFq5T6G1MLV9NnLgDEVApcnbVIQ4KWZoo8A/rvJPe7TYqrUZe7xyB+P5/amtpTNDzDuWq8ygH3UTx2HaO6B7wFkytxusjJj+mKJ4Vw3AKuXJEAPs2TzTi/g5As0qphWAlxtNwBWLxafb7eBH1AHWu/fxquA7Rx3kQlZ+eKIwbk2jyXHxJGqhSN+AMs3nV4vHQnWmZ4M2GMAJmFBgWryQjagnuhFnPTmBZBOasOU7KxTyGwKsoC8gITTk3rC7zlYFhLGAFJeu7a0AqQowLDQY3KYZ/vZ0EABgK/63O20f75WXh2/rJWvAlZSV8z4Xa18HbCQujK0PetIRnW5AaeCFi0UnJbOJBCwmPuQRUGjzAsHfF8rL+d/qM0XjPvjAdvt7iJTZLSWutqxGqmrp0xcgEQ28KCd6/Q1NqdfF+oFmMT/c4mzlLqSi+oBPBV0xa3lhdTDBwAcpD8H0CcAkpI9Dkp6MrAfkC5J3XHGvn+hQADg3dFuWqch3w8ILX8AJ1nId3wPHbAAAAAASUVORK5CYII=" style="display: none" id="font_img">
        <canvas width=256 height=350 id="font" style="display: none"></canvas>
        <textarea id="pastebox"></textarea>
        <br>
        <div style="position: absolute" class="main-container">
            <div class="border-top-left"></div><div class="border-top"></div><div class="border-top-right"></div><br>
            <div class="border-left"></div><canvas id="terminal" width=620px height=350px></canvas><div class="border-right"></div><br>
            <div class="border-bottom-left"></div><div class="border-bottom"></div><div class="border-bottom-right"></div>
        </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
        <script>
            vscode.postMessage({getFontPath: true});
            ctx = document.getElementById("terminal").getContext("2d");
            ctx.fillStyle = "#191919";
            ctx.fillRect(0, 0, 620, 350);
            ctxdata = ctx.createImageData(612, 342);
            document.getElementById("font_img").onload = function() {
                document.getElementById("font").getContext("2d").drawImage(document.getElementById("font_img"), 0, 0);
                font = document.getElementById("font").getContext("2d").getImageData(0, 0, 256, 350);
            }
            document.addEventListener("keydown", events.key);
            document.addEventListener("keyup", events.key_up);
            document.getElementById("terminal").addEventListener("mousedown", events.mouse_click);
            document.getElementById("terminal").addEventListener("mouseup", events.mouse_up);
            document.getElementById("terminal").addEventListener("wheel", events.mouse_scroll);
            document.getElementById("terminal").addEventListener("mousemove", events.mouse_drag);
            document.getElementById("pastebox").addEventListener("paste", events.paste);
            document.addEventListener("onvisibilitychange", () => {
                document.getElementById("pastebox").focus();
                document.getElementById("pastebox").select();
            });
            document.getElementById("pastebox").focus();
            document.getElementById("pastebox").select();
        </script>
    </body>
</html>
